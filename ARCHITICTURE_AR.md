# هندسة منصة بدر لأعمال الدليفري

## جدول المحتويات
- [المقدمة](#المقدمة)
  - [الخلفية والدوافع](#الخلفية-والدوافع)
- [نظرة عامة](#نظرة-عامة)
- [تفصيل الوحدات](#تفصيل-الوحدات)
  - [1. وحدة التوثيق](#1-وحدة-التوثيق)
  - [2. وحدة الثوابت](#2-وحدة-الثوابت)
  - [3. وحدة المندوب](#3-وحدة-المندوب)
  - [4. وحدة العميل](#4-وحدة-العميل)
  - [5. وحدة قاعدة البيانات](#5-وحدة-قاعدة-البيانات)
  - [6. وحدة فيربيز](#6-وحدة-فيربيز)
  - [7. وحدة التسجيل (اللوجر)](#7-وحدة-التسجيل-اللوجر)
  - [8. وحدة الإشعارات](#8-وحدة-الإشعارات)
  - [9. وحدة الطلبات](#9-وحدة-الطلبات)
  - [10. وحدة OTP](#10-وحدة-otp)
  - [11. وحدة المدفوعات](#11-وحدة-المدفوعات)
  - [12. وحدة الترجمة](#12-وحدة-الترجمة)
  - [13. وحدة الأدوات المساعدة](#13-وحدة-الأدوات-المساعدة)
- [الاستضافة والنشر](#الاستضافة-والنشر)
- [بيئة التطوير الحالية](#بيئة-التطوير-الحالية)
  - [إعداد PWA لـ VS Code Server](#إعداد-pwa-ـ-vs-code-server)
- [التحديات والقرارات التقنية](#التحديات-والقرارات-التقنية)
- [الاختبار وتتبع الأخطاء](#الاختبار-وتتبع-الأخطاء)
- [التحسينات المستقبلية](#التحسينات-المستقبلية)
- [نموذج التسعير العادل](#نموذج-التسعير-العادل)
- [الملاحظات والتوصيات](#الملاحظات-والتوصيات)

---

## المقدمة

**منصة بدر لأعمال الدليفري** هي تطبيق توصيل مستوحى من التجربة الواقعية كطيار توصيل. تم تصميم المنصة لتتطور في مراحل MVP مع التركيز على التصميم المتمحور حول المستخدم، الأمان، وقابلية التوسع. تعد هذه الوثيقة سجلاً حياً للهندسة المعمارية الحالية، الوحدات والقرارات التقنية المتخذة.

### الخلفية والدوافع

استنادًا إلى التجربة السابقة كمهندس ضمان جودة ومطور iOS، ومع إدراك ظروف العمل غير العادلة في منصات التوصيل التقليدية، تم بناء هذه المنصة لحماية حقوق الطيارين وتعزيز الشفافية. الهدف هو إنشاء نموذج عادل يتيح تحقيق دخل مستدام وكفاءة تشغيلية.

---

## نظرة عامة

تتألف المنصة من عدة وحدات تغطي التوثيق، إدارة الطلبات، معالجة المدفوعات، الإشعارات، إدارة OTP، التسجيل (اللوجر)، والمزيد. يتم استخدام نظام تحكم بالإصدارات مع توثيق مفصل لضمان تتبع كل تغيير.

---

## تفصيل الوحدات

### 1. وحدة التوثيق
- **الموقع:** `authentication/authentication.js`
- **الغرض:** إدارة تسجيل الدخول، التوثيق بخطوتين واستعادة الحساب.

### 2. وحدة الثوابت
- **الموقع:** `constants/constants.js`
- **الغرض:** تجميع الثوابت والمحددات العامة (رموز الأخطاء والإعدادات الافتراضية).

### 3. وحدة المندوب
- **الموقع:** `courier/`
- **الغرض:** إدارة منطق المندوب مثل التفاصيل الشخصية، متابعة الأرباح وتوزيع المهام (في المرحلة القادمة).

### 4. وحدة العميل
- **الموقع:** `customer/customer.js`
- **الغرض:** إدارة سجلات العملاء، تاريخ الطلبات والتفاعل معهم.

### 5. وحدة قاعدة البيانات
- **الموقع:** `database/`
- **الغرض:** التعامل مع استعلامات قاعدة البيانات وإدارة المخططات والاتصالات.

### 6. وحدة فيربيز
- **الموقع:** `firebase/`
- **الملفات:**
  - `firebase_config.js` – تهيئة فيربيز وإعداد الإعدادات البيئية.
  - `firebase_auth.js` – إدارة التوثيق باستخدام فيربيز.
  - `firebase_db.js` – التعامل مع استعلامات Firestore أو Realtime Database.
  - `firebase_storage.js` – إدارة رفع واسترجاع الملفات.
  - `firebase_functions.js` – غلاف للتعامل مع وظائف فيربيز السحابية (إذا تم استخدامها).

### 7. وحدة التسجيل (اللوجر)
- **الموقع:** `logger/logger.js`
- **الغرض:** تسجيل الأحداث باستخدام Winston، مع خطط لتكامل Sentry لاحقًا.

### 8. وحدة الإشعارات
- **الموقع:** `notifications/notifications.js`
- **الغرض:** إدارة الإشعارات الفورية، بما في ذلك التنبيهات والتحديثات عبر البريد الإلكتروني.

### 9. وحدة الطلبات
- **الموقع:** `orders/orders.js`
- **الغرض:** معالجة الطلبات وتتبع حالة التوصيل.

### 10. وحدة OTP
- **الموقع:** `otp/`
- **الملفات:**
  - `otp_generator.js` – توليد كلمات المرور لمرة واحدة.
  - `otp_storage.js` – تخزين مؤقت لكلمات المرور مع فترة انتهاء.
  - `otp_verifier.js` – التحقق من صحة كلمات المرور المدخلة.

### 11. وحدة المدفوعات
- **الموقع:** `payments/payments.js`
- **الغرض:** معالجة عمليات المدفوعات والتكامل مع المحفظة وبوابات الدفع.

### 12. وحدة الترجمة
- **الموقع:** `translation/translation.js`
- **الغرض:** توفير الدعم اللغوي المتعدد (العربية والإنجليزية).

### 13. وحدة الأدوات المساعدة
- **الموقع:** `utils/`
- **الملفات:**
  - `utils.js` – يحوي الدوال المساعدة والوظائف المشتركة.
  - `utils.js.bak` – نسخة احتياطية من الأدوات.

---

## الاستضافة والنشر

كانت الخطة الأولية لاستضافة التطبيق على فيربيز، لكن متطلبات تفعيل وظائف فيربيز (بطاقة ائتمان أو خصم) دفعتنا للتفكير في حلول بديلة للخدمات السحابية التي تقلل التكاليف خلال مرحلة MVP.

---

## بيئة التطوير الحالية

- **الجهاز:** هاتف Oppo A18 يعمل على بيئة Ubuntu ضمن Termux.
- **الأدوات:** يستخدم VS Code Server (مع Firefox لتحسين استجابة النقر)، إلى جانب تطبيق لوحة مفاتيح وفأرة عبر Bluetooth.
- **الإتصال:** اتصال 4G مستقر.
- **إضافات:** حلول مؤقتة مثل استخدام OTG دونل وتوفير الطاقة حتى يتم الحصول على إعداد حواسيب ومحيط تطوير ملائم.

### إعداد PWA لـ VS Code Server

- **النتائج:**
  - **PWA في Chrome:** بالرغم من التثبيت كـ PWA، يستمر تطبيق Chrome في إعادة تحميل الجلسة كما في التبويب العادي ويظهر نفس مشكلة نقر الفأرة.
  - **"إضافة إلى شاشة الرئيسية" في Firefox:** ينشئ اختصارًا فحسب وتظل مشكلة البقاء في الخلفية قائمة.
- **الملخص:** لم تنجح المحاولات باستخدام PWA في حل مشكلة إعادة تحميل التبويبات؛ وسيتم العودة إلى بيئة تطوير مكتبية بمجرد توفرها.

---

## التحديات والقرارات التقنية

- **تأجيل تطوير الواجهات والمتحكمات:**  
  تم تأجيل تطوير الواجهات حتى يتم تثبيت منطق الـ MVP الأساسي لتجنب التشتيت.
- **التحديات البيئية:**  
  ظروف العمل غير العادلة وعمولات المنصات العالية (~50%) تؤثر سلبًا على دخل الطيارين.
- **قيود الأجهزة:**  
  العمل باستخدام هاتف محمول مع محدودية الشاشة والأدوات الخارجية يؤدي إلى انخفاض الكفاءة.

---

## الاختبار وتتبع الأخطاء

- **الاختبار:**  
  يتم استخدام إطار عمل Jest لإجراء اختبارات الوحدة عبر جميع الوحدات، وتوجد جميع ملفات الاختبار في مجلد `tests/`.
- **رصد الأخطاء:**  
  تُدار السجلات باستخدام نظام Winston، مع خطة تكامل مستقبلية مع Sentry لتعزيز تتبع الأخطاء.

---

## التحسينات المستقبلية

- **تخزين OTP:**  
  الانتقال من التخزين المؤقت على الذاكرة إلى تخزين دائم باستخدام Firestore.
- **تضمن تكامل مع Slack والذكاء الاصطناعي:**  
  استكشاف إمكانيات تكامل بوت مخصص لـ Slack والأدوات الذكية لتحسين تتبع المهام.
- **تطوير المتحكمات والواجهات:**  
  بعد إتمام منطق الـ MVP، سيتم التركيز على تطوير الواجهات وتطبيقات المتحكمات لتحسين تجربة الطلب والتوصيل.
- **ترقية الأجهزة الطرفية:**  
  الاستثمار في أجهزة OTG أكثر كفاءة أو الانتقال إلى إعداد مكتبي عندما يكون ذلك ممكنًا.

---

## نموذج التسعير العادل

### الهدف
يهدف هذا النموذج إلى تحقيق شفافية كاملة بين الطيارين والعملاء مع ضمان حصول الطيار على دخل عادل بإزالة العمولات المرتفعة المفروضة من منصات التوصيل التقليدية. يمنح النظام الطيار الحرية في تحديد الأسعار مع تحمل العميل لتكلفة الانتظار، مما يضمن سرعة وكفاءة تنفيذ الطلبات.

### المبادئ الأساسية

- **عمولة المنصة لا تتجاوز 10%:**  
  على عكس المنصات الأخرى التي تخصم حتى 50%، فإن عمولة المنصة هنا لا تتعدى 10%.
- **تكلفة الانتظار على عاتق العميل:**  
  يتم احتساب وقت الانتظار بناءً على الساعات وفق تعريفة معلومة مسبقًا، مما يجعل العميل يتحمل تكلفة التأخير.
- **تحديد الأسعار من قبل الطيار:**  
  يحدد كل طيار أسعار التوصيل والانتظار بناءً على ظروفه الخاصة.
- **احتساب المسافة بناءً على الطريق الفعلي الأسرع:**  
  تُحسب التكلفة استنادًا إلى أسرع مسار فعلي على الأرض بدلاً من المسافة المستقيمة.
- **احتساب المسافة الكاملة:**  
  يشمل الحساب المسافة من موقع الطيار حتى نقطة الاستلام ومن ثم نقطة التسليم.
- **تقديم تقدير أولي للأجرة:**  
  يقدم النظام تقديرًا للمسافة الإجمالية والأجرة المتوقعة، لكن السعر النهائي يتم تحديده بناءً على الاتفاق المباشر بين الطيار والعميل.
- **تقديم الطيار لعرض على الطلب:**  
  يتيح النظام للطيران تقديم عرضه الخاص على الطلبات المتاحة بما يتناسب مع ظروفه، مما يعزز المنافسة العادلة والمرونة.

### آلية العمل

1. **اختيار الطلبات:**  
   يراجع الطيار الطلبات المتاحة مع تقدير للمسافة الكلية والأجرة المتوقعة، لكن تحديد السعر النهائي يكون بيده.
2. **تقديم عرض الطيار:**  
   يقدم الطيار عرضه الخاص بناءً على الظروف والمسافة.
3. **اتفاق العميل:**  
   يختار العميل العرض الأنسب بناءً على التقديرات.
4. **تنفيذ الطلب:**  
   يتم تنفيذ الطلب وفق الشروط المتفق عليها بين الطرفين.

### المزايا التنافسية

- **حماية حقوق الطيارين:**  
  مع عمولة منصة محددة بحد أقصى 10%، يحتفظ الطيارون بمعظم الأجرة بالمقارنة مع النظم التقليدية.
- **تشجيع على التنفيذ السريع:**  
  تحمل تكلفة الانتظار للعميل يحفز الطيار على إتمام الطلبات بأسرع وقت.
- **تمثيل دقيق للأجرة:**  
  تحتسب الأجرة استناداً إلى المسافة الفعلية المقطوعة وليس على أساس تخمينات غير دقيقة.
- **نظام ديناميكي ومرن:**  
  يتمتع الطيارون بالمرونة في ضبط الأسعار وفق ظروفهم، بينما يمكن للعميل مقارنة العروض واختيار الأنسب.

---

## الملاحظات والتوصيات

- **التوثيق الدوري:**  
  يجب تحديث هذه الوثيقة بانتظام لتعكس التغييرات والقرارات الجديدة والتحسينات.
- **تحسين الأجهزة الطرفية:**  
  الاستثمار في تحسين الأدوات (أجهزة OTG أو الانتقال إلى بيئة مكتبية) سيزيد من الإنتاجية.
- **التركيز على الاستدامة:**  
  يهدف النموذج العادل وهندسة المنصة إلى خلق خدمة توصيل أكثر استدامة وإنصافاً لجميع الأطراف.